<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìª Ranger Radio - Recording History</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .history-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: #2c3e50;
            color: white;
            border-radius: 8px;
        }
        
        .recording-list {
            display: grid;
            gap: 15px;
        }
        
        .recording-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .recording-info {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .recording-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .recording-meta {
            font-size: 0.9em;
            color: #666;
        }
        
        .recording-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .play-button {
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .play-button:hover {
            background: #229954;
        }
        
        .play-button.playing {
            background: #e74c3c;
        }
        
        .download-button {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .download-button:hover {
            background: #2980b9;
        }
        
        .delete-button {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .delete-button:hover {
            background: #c0392b;
        }
        
        .clear-all-button {
            background: #e67e22;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .clear-all-button:hover {
            background: #d35400;
        }
        
        .back-button {
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
        }
        
        .back-button:hover {
            background: #7f8c8d;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .search-bar {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="history-container">
        <div class="header-bar">
            <h1>üìª Ranger Radio - Recording History</h1>
            <div>
                <a href="index.html" class="back-button">‚Üê Back to Radio</a>
                <button id="clear-all" class="clear-all-button">Clear All Recordings</button>
            </div>
        </div>
        
        <div class="stats-bar">
            <div class="stat-item">
                <div id="total-recordings" class="stat-value">0</div>
                <div class="stat-label">Total Recordings</div>
            </div>
            <div class="stat-item">
                <div id="total-duration" class="stat-value">0:00</div>
                <div class="stat-label">Total Duration</div>
            </div>
            <div class="stat-item">
                <div id="storage-used" class="stat-value">0 MB</div>
                <div class="stat-label">Storage Used</div>
            </div>
        </div>
        
        <div class="search-bar">
            <input type="text" id="search-input" class="search-input" placeholder="Search recordings by callsign or date...">
        </div>
        
        <div id="recording-list" class="recording-list">
            <div class="empty-state">
                <h3>No recordings found</h3>
                <p>Start using the radio to create recording history</p>
            </div>
        </div>
    </div>

    <script>
        let recordings = [];
        let currentlyPlaying = null;
        let audioContext = null;
        
        // Initialize audio context
        function initAudioContext() {
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
            } catch (error) {
                console.error('Web Audio API not supported:', error);
            }
        }
        
        // Load recordings from localStorage
        function loadRecordings() {
            const stored = localStorage.getItem('rangerRadioRecordings');
            if (stored) {
                recordings = JSON.parse(stored);
            }
            updateStats();
            renderRecordings();
        }
        
        // Save recordings to localStorage
        function saveRecordings() {
            localStorage.setItem('rangerRadioRecordings', JSON.stringify(recordings));
        }
        
        // Update statistics
        function updateStats() {
            document.getElementById('total-recordings').textContent = recordings.length;
            
            const totalDuration = recordings.reduce((sum, rec) => sum + (rec.duration || 0), 0);
            const minutes = Math.floor(totalDuration / 60);
            const seconds = Math.floor(totalDuration % 60);
            document.getElementById('total-duration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const totalSize = recordings.reduce((sum, rec) => sum + (rec.size || 0), 0);
            document.getElementById('storage-used').textContent = `${(totalSize / 1024 / 1024).toFixed(1)} MB`;
        }
        
        // Render recordings list
        function renderRecordings() {
            const container = document.getElementById('recording-list');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            const filteredRecordings = recordings.filter(rec => 
                rec.callsign.toLowerCase().includes(searchTerm) ||
                rec.timestamp.toLowerCase().includes(searchTerm)
            );
            
            if (filteredRecordings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No recordings found</h3>
                        <p>${searchTerm ? 'Try a different search term' : 'Start using the radio to create recording history'}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredRecordings.map((recording, index) => `
                <div class="recording-item" data-index="${index}">
                    <div class="recording-info">
                        <div class="recording-title">
                            ${recording.callsign} - ${recording.type}
                        </div>
                        <div class="recording-meta">
                            üìÖ ${recording.timestamp} ‚Ä¢ ‚è±Ô∏è ${formatDuration(recording.duration)} ‚Ä¢ üìä ${formatSize(recording.size)}
                        </div>
                    </div>
                    <div class="recording-controls">
                        <button class="play-button" onclick="togglePlayback(${recording.id})">
                            ‚ñ∂Ô∏è Play
                        </button>
                        <button class="download-button" onclick="downloadRecording(${recording.id})">
                            ‚¨áÔ∏è Download
                        </button>
                        <button class="delete-button" onclick="deleteRecording(${recording.id})">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Format duration
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Format file size
        function formatSize(bytes) {
            if (!bytes) return '0 KB';
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
            return `${(bytes / 1024 / 1024).toFixed(1)} MB`;
        }
        
        // Toggle playback
        function togglePlayback(recordingId) {
            const recording = recordings.find(r => r.id === recordingId);
            if (!recording) return;
            
            const button = document.querySelector(`[data-index="${recordings.indexOf(recording)}"] .play-button`);
            
            if (currentlyPlaying && currentlyPlaying.id === recordingId) {
                // Stop current playback
                if (currentlyPlaying.source) {
                    currentlyPlaying.source.stop();
                }
                currentlyPlaying = null;
                button.textContent = '‚ñ∂Ô∏è Play';
                button.classList.remove('playing');
            } else {
                // Start new playback
                if (currentlyPlaying && currentlyPlaying.source) {
                    currentlyPlaying.source.stop();
                    const prevButton = document.querySelector('.play-button.playing');
                    if (prevButton) {
                        prevButton.textContent = '‚ñ∂Ô∏è Play';
                        prevButton.classList.remove('playing');
                    }
                }
                
                playRecording(recording);
                button.textContent = '‚èπÔ∏è Stop';
                button.classList.add('playing');
            }
        }
        
        // Play recording
        function playRecording(recording) {
            if (!audioContext || !recording.audioData) return;
            
            try {
                // Convert stored PCM data back to audio buffer
                const pcmArray = new Int16Array(recording.audioData);
                const sampleRate = recording.sampleRate || 44100;
                
                const audioBuffer = audioContext.createBuffer(1, pcmArray.length, sampleRate);
                const bufferData = audioBuffer.getChannelData(0);
                
                for (let i = 0; i < pcmArray.length; i++) {
                    bufferData[i] = pcmArray[i] / 32768;
                }
                
                const source = audioContext.createBufferSource();
                const gainNode = audioContext.createGain();
                
                source.buffer = audioBuffer;
                source.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                gainNode.gain.value = 0.7;
                
                source.onended = () => {
                    currentlyPlaying = null;
                    const button = document.querySelector('.play-button.playing');
                    if (button) {
                        button.textContent = '‚ñ∂Ô∏è Play';
                        button.classList.remove('playing');
                    }
                };
                
                source.start();
                currentlyPlaying = { id: recording.id, source };
                
            } catch (error) {
                console.error('Playback error:', error);
                alert('Error playing recording');
            }
        }
        
        // Download recording
        function downloadRecording(recordingId) {
            const recording = recordings.find(r => r.id === recordingId);
            if (!recording || !recording.audioData) return;
            
            // Create a simple WAV file from the PCM data
            const pcmArray = new Int16Array(recording.audioData);
            const sampleRate = recording.sampleRate || 44100;
            const wavBuffer = createWavFile(pcmArray, sampleRate);
            
            const blob = new Blob([wavBuffer], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${recording.callsign}_${recording.timestamp.replace(/[^\w]/g, '_')}.wav`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Create WAV file from PCM data
        function createWavFile(pcmData, sampleRate) {
            const length = pcmData.length;
            const buffer = new ArrayBuffer(44 + length * 2);
            const view = new DataView(buffer);
            
            // WAV header
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * 2, true);
            
            // PCM data
            for (let i = 0; i < length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }
            
            return buffer;
        }
        
        // Delete recording
        function deleteRecording(recordingId) {
            if (confirm('Are you sure you want to delete this recording?')) {
                recordings = recordings.filter(r => r.id !== recordingId);
                saveRecordings();
                updateStats();
                renderRecordings();
            }
        }
        
        // Clear all recordings
        function clearAllRecordings() {
            if (confirm('Are you sure you want to delete ALL recordings? This cannot be undone.')) {
                recordings = [];
                localStorage.removeItem('rangerRadioRecordings');
                updateStats();
                renderRecordings();
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            initAudioContext();
            loadRecordings();
            
            document.getElementById('clear-all').addEventListener('click', clearAllRecordings);
            document.getElementById('search-input').addEventListener('input', renderRecordings);
        });
        
        // Listen for new recordings from the main app
        window.addEventListener('storage', (e) => {
            if (e.key === 'rangerRadioRecordings') {
                loadRecordings();
            }
        });
    </script>
</body>
</html> 