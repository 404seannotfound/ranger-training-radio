<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìª Ranger Radio Training - Khaki Command Network</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .khaki-header {
            background: linear-gradient(135deg, #8B4513, #A0522D);
            color: #F5DEB3;
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .khaki-header h1 {
            margin: 0;
            font-size: 2.2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .khaki-header p {
            margin: 10px 0 0 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .command-info {
            background: #F5DEB3;
            border: 2px solid #8B4513;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .command-info h3 {
            color: #8B4513;
            margin: 0 0 10px 0;
        }
        
        .auto-callsign {
            font-size: 1.5em;
            font-weight: bold;
            color: #A0522D;
            background: white;
            padding: 10px;
            border-radius: 5px;
            display: inline-block;
            margin: 10px 0;
        }
        
        .regular-radio-link {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #95a5a6;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            z-index: 1000;
        }
        
        .regular-radio-link:hover {
            background: #7f8c8d;
        }
        
        .khaki-version {
            font-size: 0.8em;
            opacity: 0.6;
            font-weight: normal;
            color: #D2B48C;
        }
        
        /* Recordings Section Styles */
        .recordings-section {
            background: #fff;
            border: 2px solid #8B4513;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .recordings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #8B4513;
        }
        
        .recordings-title {
            color: #8B4513;
            font-size: 1.4em;
            font-weight: bold;
            margin: 0;
        }
        
        .clear-recordings-button {
            background: #e67e22;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .clear-recordings-button:hover {
            background: #d35400;
        }
        
        .recordings-stats {
            display: flex;
            justify-content: space-around;
            background: #F5DEB3;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #8B4513;
        }
        
        .recordings-stat {
            text-align: center;
        }
        
        .recordings-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #8B4513;
        }
        
        .recordings-stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
        
        .recordings-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        .recording-item {
            background: white;
            border-bottom: 1px solid #ddd;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .recording-item:last-child {
            border-bottom: none;
        }
        
        .recording-item:hover {
            background: #f0f0f0;
        }
        
        .recording-info {
            flex-grow: 1;
        }
        
        .recording-title {
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 3px;
        }
        
        .recording-meta {
            font-size: 0.8em;
            color: #666;
        }
        
        .recording-summary {
            font-size: 0.85em;
            color: #8B4513;
            font-style: italic;
            margin-top: 3px;
        }
        
        .conversation-flow {
            font-size: 0.8em;
            color: #666;
            font-family: monospace;
            margin-top: 3px;
            padding: 3px 6px;
            background: #f8f9fa;
            border-radius: 3px;
            border-left: 3px solid #8B4513;
        }
        
        .recording-controls {
            display: flex;
            gap: 8px;
        }
        
        .recording-button {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: white;
        }
        
        .play-button {
            background: #27ae60;
        }
        
        .play-button:hover {
            background: #229954;
        }
        
        .play-button.playing {
            background: #e74c3c;
        }
        
        .download-button {
            background: #3498db;
        }
        
        .download-button:hover {
            background: #2980b9;
        }
        
        .delete-button {
            background: #e74c3c;
        }
        
        .delete-button:hover {
            background: #c0392b;
        }
        
        .recordings-empty {
            text-align: center;
            padding: 30px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <a href="index.html" class="regular-radio-link" onclick="window.open('index.html', '_blank'); return false;">ÔøΩÔøΩ Regular Radio</a>
    
    <div class="container">
        <div class="khaki-header">
            <h1>üéñÔ∏è KHAKI COMMAND NETWORK</h1>
            <p>Command Staff Radio Training Interface <span class="khaki-version">v2.0.0</span></p>
        </div>
        
        <!-- Login Screen -->
        <div id="login-screen" class="login-container">
            <div class="command-info">
                <h3>üéñÔ∏è Khaki Command Staff Access</h3>
                <p>Welcome to the Command Network. You will be automatically assigned a Khaki callsign.</p>
                <div class="auto-callsign" id="assigned-callsign">
                    Determining Khaki number...
                </div>
                <p><em>Multiple Khaki units can operate simultaneously with unique identifiers.</em></p>
            </div>
            
            <div class="login-form">
                <button id="join-button" class="join-button">
                    üéñÔ∏è Join Khaki Command Network
                </button>
            </div>
        </div>
        
        <!-- Radio Interface -->
        <div id="radio-interface" class="radio-interface" style="display: none;">
            <!-- Hidden input that app.js expects - must exist before app.js loads -->
            <input type="hidden" id="callsign" value="KHAKI">
            
            <!-- Hidden elements that app.js expects -->
            <div id="preset-messages-button" style="display: none;"></div>
            <div id="preset-messages-modal" style="display: none;"></div>
            <div id="close-modal" style="display: none;"></div>
            
            <div class="command-info">
                <h3>üéñÔ∏è Command Staff: <span id="current-callsign">KHAKI</span></h3>
                <p>You are operating on the Command Network with full monitoring capabilities.</p>
            </div>
            
            <div class="status-panel">
                <div class="status-indicator-container">
                    <div id="status-indicator" class="status-indicator status-offline">OFFLINE</div>
                    <div id="transmission-indicator" class="transmission-indicator">
                        <span class="pulse-dot"></span>
                        TRANSMITTING
                    </div>
                </div>
            </div>
            
            <div class="ptt-container">
                <button id="ptt-button" class="ptt-button">
                    <span class="ptt-text">PUSH TO TALK</span>
                    <span class="ptt-subtext">Hold to transmit</span>
                </button>
            </div>
            
            <div class="controls-panel">
                <div class="volume-control">
                    <label for="volume-slider">üîä Volume:</label>
                    <input type="range" id="volume-slider" min="0" max="100" value="70" class="volume-slider">
                    <span id="volume-display">70%</span>
                </div>
                
                <button id="exit-button" class="exit-button">
                    ‚¨ÖÔ∏è Exit Network
                </button>
            </div>
            
            <!-- Audio Device Selection -->
            <div class="audio-devices-section">
                <h3>üéß Audio Devices</h3>
                <div class="device-controls">
                    <div class="device-group">
                        <label for="microphone-select">üé§ Microphone:</label>
                        <select id="microphone-select" class="device-select">
                            <option value="">Loading devices...</option>
                        </select>
                    </div>
                    
                    <div class="device-group">
                        <label for="speaker-select">üîä Speaker:</label>
                        <select id="speaker-select" class="device-select">
                            <option value="">Loading devices...</option>
                        </select>
                    </div>
                    
                    <button id="refresh-devices-button" class="refresh-button">üîÑ Refresh Devices</button>
                </div>
                
                <div class="mic-test-section">
                    <button id="mic-test-button" class="mic-test-button">üé§ Test Microphone</button>
                    <div class="mic-level-container">
                        <div id="mic-level" class="mic-level-indicator"></div>
                    </div>
                </div>
            </div>
            
            <!-- Audio Effects -->
            <div class="effects-panel">
                <h3>üìª Radio Effects</h3>
                <div class="effects-grid">
                    <label class="effect-toggle">
                        <input type="checkbox" id="access-tone-toggle" checked>
                        <span>üîî Access Tone</span>
                    </label>
                    <label class="effect-toggle">
                        <input type="checkbox" id="roger-beep-toggle" checked>
                        <span>üì∂ Roger Beep</span>
                    </label>
                    <label class="effect-toggle">
                        <input type="checkbox" id="squelch-tail-toggle" checked>
                        <span>üîá Squelch Tail</span>
                    </label>
                    <label class="effect-toggle">
                        <input type="checkbox" id="background-noise-toggle">
                        <span>üåä Background Noise</span>
                    </label>
                    <label class="effect-toggle">
                        <input type="checkbox" id="radio-effects-toggle" checked>
                        <span>üìª Radio Processing</span>
                    </label>
                </div>
            </div>
            
            <!-- Activity Log -->
            <div class="activity-panel">
                <h3>üìã Command Network Activity</h3>
                <div id="activity-log" class="activity-log"></div>
            </div>
            
            <!-- Recordings Section -->
            <div class="recordings-section">
                <div class="recordings-header">
                    <h3 class="recordings-title">üìº Radio Sessions</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="finish-session-button" class="clear-recordings-button" style="background: #27ae60;">üìº Finish Current Session</button>
                        <button id="clear-all-recordings" class="clear-recordings-button">üóëÔ∏è Clear All</button>
                    </div>
                </div>
                
                <div class="recordings-stats">
                    <div class="recordings-stat">
                        <div id="total-recordings" class="recordings-stat-value">0</div>
                        <div class="recordings-stat-label">Total</div>
                    </div>
                    <div class="recordings-stat">
                        <div id="total-duration" class="recordings-stat-value">0:00</div>
                        <div class="recordings-stat-label">Duration</div>
                    </div>
                    <div class="recordings-stat">
                        <div id="storage-used" class="recordings-stat-value">0 MB</div>
                        <div class="recordings-stat-label">Storage</div>
                    </div>
                </div>
                
                <div id="recordings-list" class="recordings-list">
                    <div class="recordings-empty">
                        No radio sessions recorded yet. Conversations will be automatically saved as complete sessions.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Load configuration first -->
    <script src="config-loader.js"></script>
    <!-- Add Socket.IO library from CDN -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Khaki-specific functionality - Set up IMMEDIATELY
        let assignedKhakiNumber = null;
        let khakiCallsign = null;
        
        // Recordings functionality - SESSION BASED
        let recordings = [];
        let currentlyPlaying = null;
        let recordingsAudioContext = null;
        let currentSession = null;
        let sessionStartTime = null;
        const MIN_TRANSMISSION_DURATION = 2; // seconds - ignore transmissions shorter than this (noise/accidental key-ups)
        const SESSION_TIMEOUT = 45; // seconds - close session after this much silence (longer for radio conversations)
        let sessionTimeout = null;
        
        // Auto-assign Khaki number and update DOM immediately
        function assignKhakiNumber() {
            // Try to get a unique number (1-99)
            for (let i = 1; i <= 99; i++) {
                assignedKhakiNumber = i;
                khakiCallsign = i === 1 ? 'KHAKI' : `KHAKI-${i}`;
                break;
            }
            
            // Update the UI elements immediately
            const assignedElement = document.getElementById('assigned-callsign');
            if (assignedElement) {
                assignedElement.textContent = khakiCallsign;
            }
            
            const callsignInput = document.getElementById('callsign');
            if (callsignInput) {
                callsignInput.value = khakiCallsign;
            }
            
            const currentCallsign = document.getElementById('current-callsign');
            if (currentCallsign) {
                currentCallsign.textContent = khakiCallsign;
            }
            
            // Set global variable immediately
            window.rangerCallsign = khakiCallsign;
            
            console.log('üéñÔ∏è Assigned Khaki callsign:', khakiCallsign);
            return khakiCallsign;
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéñÔ∏è DOM loaded, initializing Khaki interface...');
            
            // Assign Khaki number immediately
            assignKhakiNumber();
            
            // Initialize recordings
            initRecordingsAudioContext();
            loadRecordings();
            
            // Add clear recordings button listener
            const clearButton = document.getElementById('clear-all-recordings');
            if (clearButton) {
                clearButton.addEventListener('click', clearAllRecordings);
            }
            
            // Add finish session button listener
            const finishButton = document.getElementById('finish-session-button');
            if (finishButton) {
                finishButton.addEventListener('click', () => {
                    if (currentSession) {
                        finishCurrentSession();
                        addToActivityLog('üìº Current recording session saved manually');
                    } else {
                        alert('No active recording session to save');
                    }
                });
            }
            
            // Update finish session button visibility
            setInterval(() => {
                const finishButton = document.getElementById('finish-session-button');
                if (finishButton) {
                    if (currentSession) {
                        finishButton.style.display = 'block';
                        finishButton.style.background = '#27ae60';
                        finishButton.textContent = `üìº Finish Session (${currentSession.transmissions.length} transmissions)`;
                    } else {
                        finishButton.style.display = 'none';
                    }
                }
            }, 1000);
            
            console.log('‚úÖ Khaki interface initialized, ready for app.js');
        });
        
        // Set up additional functionality after page loads
        window.addEventListener('load', () => {
            console.log('üéñÔ∏è Page fully loaded, setting up additional Khaki functionality...');
            
            // Set up join button with simple logic
            const joinButton = document.getElementById('join-button');
            if (joinButton) {
                joinButton.addEventListener('click', () => {
                    console.log('üéñÔ∏è Khaki join button clicked');
                    
                    // Ensure we have a callsign
                    if (!khakiCallsign) {
                        assignKhakiNumber();
                    }
                    
                    // Set the callsign input that app.js expects
                    const callsignInput = document.getElementById('callsign');
                    if (callsignInput) {
                        callsignInput.value = khakiCallsign;
                        console.log('Set callsign input to:', khakiCallsign);
                    }
                    
                    console.log('üì° Calling joinNetwork...');
                    
                    // Just call the global joinNetwork function
                    if (typeof joinNetwork === 'function') {
                        joinNetwork();
                    } else {
                        console.error('joinNetwork function not found');
                        alert('Radio system not ready. Please refresh the page and try again.');
                    }
                });
            }
            
            // Add special Khaki logging and hook into recording system
            if (window.addToActivityLog && typeof window.addToActivityLog === 'function') {
                const originalAddToActivityLog = window.addToActivityLog;
                window.addToActivityLog = function(message) {
                    // Add Khaki prefix to certain messages
                    if (message.includes('joined the radio network')) {
                        message = `üéñÔ∏è Command Staff ${message}`;
                    }
                    
                    // Check for transmission start/end to manage sessions
                    if (message.includes('started transmitting')) {
                        const callsign = message.split(' ')[0];
                        if (!currentSession) {
                            startNewSession();
                        }
                    }
                    
                    // Call original function
                    originalAddToActivityLog(message);
                    
                    // Check for recording saved messages from app.js
                    if (message.includes('Recording saved')) {
                        // Wait a bit then check for new recordings
                        setTimeout(() => {
                            checkForNewRecordings();
                        }, 100);
                    }
                };
                
                // Show initial Khaki instructions
                setTimeout(() => {
                    window.addToActivityLog('üéñÔ∏è Khaki Command Network Interface Loaded');
                    window.addToActivityLog(`Assigned callsign: ${khakiCallsign}`);
                    window.addToActivityLog('Click "Join Khaki Command Network" to begin operations');
                    window.addToActivityLog('üì° Command staff can monitor all radio traffic');
                }, 500);
            }
            
            // Check for new recordings without overriding localStorage
            function checkForNewRecordings() {
                try {
                    const stored = localStorage.getItem('rangerRadioRecordings');
                    if (stored) {
                        const allRecordings = JSON.parse(stored);
                        const lastRecording = allRecordings[allRecordings.length - 1];
                        
                        if (lastRecording && lastRecording.audioData && lastRecording.duration) {
                            // Check if this is a new recording we haven't processed
                            const lastProcessedId = window.lastProcessedRecordingId || 0;
                            if (lastRecording.id > lastProcessedId) {
                                window.lastProcessedRecordingId = lastRecording.id;
                                
                                // Add this transmission to the current session
                                addTransmissionToSession(
                                    lastRecording.callsign,
                                    lastRecording.audioData,
                                    lastRecording.duration
                                );
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking for new recordings:', error);
                }
            }
        });
        
        // Initialize recordings audio context
        function initRecordingsAudioContext() {
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                recordingsAudioContext = new AudioContext();
            } catch (error) {
                console.error('Web Audio API not supported for recordings:', error);
            }
        }
        
        // Load recordings from localStorage
        function loadRecordings() {
            try {
                const stored = localStorage.getItem('rangerRadioRecordings');
                if (stored) {
                    recordings = JSON.parse(stored);
                    // Sort by timestamp (most recent first)
                    recordings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // Limit to 20 most recent recordings to prevent quota exceeded
                    if (recordings.length > 20) {
                        recordings = recordings.slice(0, 20);
                        console.log('üìº Trimmed recordings to 20 most recent to manage storage');
                        saveRecordings();
                    }
                }
            } catch (error) {
                console.error('Error loading recordings:', error);
                if (error.name === 'QuotaExceededError') {
                    console.log('üóëÔ∏è Storage quota exceeded, clearing old recordings');
                    clearOldRecordings();
                }
            }
            updateRecordingsStats();
            renderRecordings();
        }
        
        // Save recordings to localStorage with error handling
        function saveRecordings() {
            try {
                localStorage.setItem('rangerRadioRecordings', JSON.stringify(recordings));
            } catch (error) {
                console.error('Error saving recordings:', error);
                if (error.name === 'QuotaExceededError') {
                    console.log('üóëÔ∏è Storage quota exceeded while saving, clearing old recordings');
                    clearOldRecordings();
                    // Try again with fewer recordings
                    try {
                        localStorage.setItem('rangerRadioRecordings', JSON.stringify(recordings));
                    } catch (secondError) {
                        console.error('Still cannot save recordings after cleanup:', secondError);
                        alert('Storage full - unable to save recordings. Please clear some manually.');
                    }
                }
            }
        }
        
        // Clear old recordings to free up storage
        function clearOldRecordings() {
            if (recordings.length > 10) {
                recordings = recordings.slice(0, 10);
                console.log('üìº Reduced recordings to 10 most recent');
            } else if (recordings.length > 5) {
                recordings = recordings.slice(0, 5);
                console.log('üìº Reduced recordings to 5 most recent');
            } else {
                recordings = [];
                console.log('üìº Cleared all recordings due to storage issues');
            }
            
            try {
                localStorage.setItem('rangerRadioRecordings', JSON.stringify(recordings));
            } catch (error) {
                localStorage.removeItem('rangerRadioRecordings');
                recordings = [];
                console.log('üìº Removed all recordings from storage');
            }
        }
        
        // Update recordings statistics
        function updateRecordingsStats() {
            const totalEl = document.getElementById('total-recordings');
            const durationEl = document.getElementById('total-duration');
            const storageEl = document.getElementById('storage-used');
            
            if (totalEl) totalEl.textContent = recordings.length;
            
            if (durationEl) {
                const totalDuration = recordings.reduce((sum, rec) => sum + (rec.duration || 0), 0);
                const minutes = Math.floor(totalDuration / 60);
                const seconds = Math.floor(totalDuration % 60);
                durationEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            if (storageEl) {
                const totalSize = recordings.reduce((sum, rec) => sum + (rec.size || 0), 0);
                storageEl.textContent = `${(totalSize / 1024 / 1024).toFixed(1)} MB`;
            }
        }
        
        // Render recordings list (most recent first)
        function renderRecordings() {
            const container = document.getElementById('recordings-list');
            if (!container) return;
            
            if (recordings.length === 0) {
                container.innerHTML = `
                    <div class="recordings-empty">
                        No radio sessions recorded yet. Conversations will be automatically saved as complete sessions.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recordings.map((session) => `
                <div class="recording-item" data-recording-id="${session.id}">
                    <div class="recording-info">
                        <div class="recording-title">
                            üìª ${session.title || `Radio Session ${session.id}`}
                        </div>
                        <div class="recording-meta">
                            üìÖ ${new Date(session.startTime).toLocaleString()} ‚Ä¢ ‚è±Ô∏è ${formatDuration(session.duration)} ‚Ä¢ 
                            üéôÔ∏è ${session.transmissions ? session.transmissions.length : 0} transmissions ‚Ä¢ 
                            üìä ${formatSize(session.size)}
                        </div>
                        ${session.summary ? `<div class="recording-summary">${session.summary}</div>` : ''}
                        ${session.conversationFlow ? `<div class="conversation-flow">üîÑ ${session.conversationFlow}</div>` : ''}
                    </div>
                    <div class="recording-controls">
                        <button class="recording-button play-button" onclick="togglePlayback(${session.id})">
                            ‚ñ∂Ô∏è Play
                        </button>
                        <button class="recording-button download-button" onclick="downloadRecording(${session.id})">
                            ‚¨áÔ∏è Download
                        </button>
                        <button class="recording-button delete-button" onclick="deleteRecording(${session.id})">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Format duration
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Format file size
        function formatSize(bytes) {
            if (!bytes) return '0 KB';
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
            return `${(bytes / 1024 / 1024).toFixed(1)} MB`;
        }
        
        // Toggle playback
        function togglePlayback(recordingId) {
            const session = recordings.find(r => r.id === recordingId);
            if (!session) return;
            
            const button = document.querySelector(`[data-recording-id="${recordingId}"] .play-button`);
            
            if (currentlyPlaying && currentlyPlaying.id === recordingId) {
                // Stop current playback
                if (currentlyPlaying.source) {
                    currentlyPlaying.source.stop();
                }
                currentlyPlaying = null;
                button.textContent = '‚ñ∂Ô∏è Play';
                button.classList.remove('playing');
            } else {
                // Start new playback
                if (currentlyPlaying && currentlyPlaying.source) {
                    currentlyPlaying.source.stop();
                    const prevButton = document.querySelector('.play-button.playing');
                    if (prevButton) {
                        prevButton.textContent = '‚ñ∂Ô∏è Play';
                        prevButton.classList.remove('playing');
                    }
                }
                
                playRecording(session);
                button.textContent = '‚èπÔ∏è Stop';
                button.classList.add('playing');
            }
        }
        
        // Play recording
        function playRecording(session) {
            if (!recordingsAudioContext || !session.audioData) return;
            
            try {
                // Convert stored PCM data back to audio buffer
                const pcmArray = new Int16Array(session.audioData);
                const sampleRate = session.sampleRate || 44100;
                
                const audioBuffer = recordingsAudioContext.createBuffer(1, pcmArray.length, sampleRate);
                const bufferData = audioBuffer.getChannelData(0);
                
                for (let i = 0; i < pcmArray.length; i++) {
                    bufferData[i] = pcmArray[i] / 32768;
                }
                
                const source = recordingsAudioContext.createBufferSource();
                const gainNode = recordingsAudioContext.createGain();
                
                source.buffer = audioBuffer;
                source.connect(gainNode);
                gainNode.connect(recordingsAudioContext.destination);
                
                gainNode.gain.value = 0.7;
                
                source.onended = () => {
                    currentlyPlaying = null;
                    const button = document.querySelector('.play-button.playing');
                    if (button) {
                        button.textContent = '‚ñ∂Ô∏è Play';
                        button.classList.remove('playing');
                    }
                };
                
                source.start();
                currentlyPlaying = { id: session.id, source };
                
            } catch (error) {
                console.error('Playback error:', error);
                alert('Error playing recording');
            }
        }
        
        // Download recording
        function downloadRecording(recordingId) {
            const session = recordings.find(r => r.id === recordingId);
            if (!session || !session.audioData) return;
            
            // Create a simple WAV file from the PCM data
            const pcmArray = new Int16Array(session.audioData);
            const sampleRate = session.sampleRate || 44100;
            const wavBuffer = createWavFile(pcmArray, sampleRate);
            
            const blob = new Blob([wavBuffer], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            const fileName = `${session.title || 'Radio_Session'}_${new Date(session.startTime).toISOString().slice(0,19).replace(/[^\w]/g, '_')}.wav`;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Create WAV file from PCM data
        function createWavFile(pcmData, sampleRate) {
            const length = pcmData.length;
            const buffer = new ArrayBuffer(44 + length * 2);
            const view = new DataView(buffer);
            
            // WAV header
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * 2, true);
            
            // PCM data
            for (let i = 0; i < length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }
            
            return buffer;
        }
        
        // Delete recording
        function deleteRecording(recordingId) {
            if (confirm('Are you sure you want to delete this radio session?')) {
                recordings = recordings.filter(r => r.id !== recordingId);
                saveRecordings();
                updateRecordingsStats();
                renderRecordings();
            }
        }
        
        // Clear all recordings
        function clearAllRecordings() {
            if (confirm('Are you sure you want to delete ALL recordings? This cannot be undone.')) {
                recordings = [];
                try {
                    localStorage.removeItem('rangerRadioRecordings');
                    console.log('üìº All recordings cleared successfully');
                } catch (error) {
                    console.error('Error clearing recordings:', error);
                }
                updateRecordingsStats();
                renderRecordings();
            }
        }
        
        // Smart recording system - Radio conversation focused
        function startNewSession() {
            if (currentSession) {
                finishCurrentSession();
            }
            
            sessionStartTime = Date.now();
            currentSession = {
                id: Date.now(),
                startTime: sessionStartTime,
                endTime: null,
                audioData: [],
                transmissions: [],
                participants: new Set(),
                sampleRate: 44100
            };
            
            console.log('üìº Started new radio conversation session:', currentSession.id);
            
            // Clear any existing timeout
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
                sessionTimeout = null;
            }
        }
        
        function addTransmissionToSession(callsign, audioData, duration) {
            // Only filter out very short transmissions (noise, accidental key-ups)
            if (duration < MIN_TRANSMISSION_DURATION) {
                console.log(`üìº Filtering noise: ${callsign} (${duration.toFixed(1)}s)`);
                return;
            }
            
            // Start new session if none exists
            if (!currentSession) {
                startNewSession();
            }
            
            // Add transmission to current session
            const transmission = {
                callsign: callsign,
                timestamp: new Date().toLocaleString(),
                duration: duration,
                audioStartIndex: currentSession.audioData.length,
                isKhaki: callsign.startsWith('KHAKI')
            };
            
            currentSession.transmissions.push(transmission);
            currentSession.audioData.push(...audioData);
            currentSession.participants.add(callsign);
            
            console.log(`üìº Added ${callsign} transmission (${duration.toFixed(1)}s) to conversation`);
            
            // Reset session timeout - conversations can have pauses
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
            }
            
            sessionTimeout = setTimeout(() => {
                console.log('üìº Session timeout - finishing conversation after silence');
                finishCurrentSession();
            }, SESSION_TIMEOUT * 1000);
        }
        
        function finishCurrentSession() {
            if (!currentSession) return;
            
            const sessionDuration = (Date.now() - sessionStartTime) / 1000;
            
            // Save ALL radio conversations - don't filter by duration
            // Even quick exchanges like "Roger" or "Copy" are important
            if (currentSession.transmissions.length === 0) {
                console.log('üìº Discarding empty session');
                currentSession = null;
                return;
            }
            
            currentSession.endTime = Date.now();
            currentSession.duration = sessionDuration;
            currentSession.size = currentSession.audioData.length * 2;
            
            // Create meaningful title based on participants (exclude KHAKI as driving node)
            const participants = Array.from(currentSession.participants);
            const nonKhakiParticipants = participants.filter(p => !p.startsWith('KHAKI'));
            const khakiParticipants = participants.filter(p => p.startsWith('KHAKI'));
            
            let title;
            if (nonKhakiParticipants.length >= 2) {
                // Conversation between field units
                title = `Radio Traffic: ${nonKhakiParticipants.join(' ‚Üî ')}`;
                if (khakiParticipants.length > 0) {
                    title += ` (+ Command)`;
                }
            } else if (nonKhakiParticipants.length === 1 && khakiParticipants.length > 0) {
                // Coordination between field unit and command
                title = `Command Coordination: ${nonKhakiParticipants[0]} ‚Üî ${khakiParticipants[0]}`;
            } else if (nonKhakiParticipants.length >= 1) {
                // Single unit traffic
                title = `Radio Traffic: ${nonKhakiParticipants.join(', ')}`;
            } else {
                // Fallback
                title = `Radio Session: ${participants.join(', ')}`;
            }
            
            currentSession.title = title;
            currentSession.summary = `${currentSession.transmissions.length} transmissions, ${participants.length} participants`;
            
            // Add conversation flow summary
            const conversationFlow = currentSession.transmissions.map(t => 
                `${t.callsign}(${t.duration.toFixed(1)}s)`
            ).join(' ‚Üí ');
            currentSession.conversationFlow = conversationFlow;
            
            // Save the session
            recordings.unshift(currentSession); // Add to beginning (newest first)
            saveRecordings();
            
            console.log(`üìº Saved radio conversation: ${currentSession.title}`);
            console.log(`üìº Flow: ${conversationFlow}`);
            
            // Clear session
            currentSession = null;
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
                sessionTimeout = null;
            }
            
            // Update UI
            updateRecordingsStats();
            renderRecordings();
        }
    </script>
    
    <!-- Load the main app functionality AFTER overrides are set -->
    <script src="app.js"></script>
</body>
</html> 